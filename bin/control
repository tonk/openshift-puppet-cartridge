#!/bin/bash

# Set envionment
source ${OPENSHIFT_CARTRIDGE_SDK_BASH}
export PUPPET_DIR=${OPENSHIFT_PUPPET_DIR}
export PUPPET_CFG_DIR="${OPENSHIFT_HOMEDIR}/.puppet"
export PATH=${PUPPET_DIR}/bin/puppet/bin:${PUPPET_DIR}/bin/facter/bin:${PATH}
export RUBYLIB=${PUPPET_DIR}/bin//puppet/lib

pid=${PUPPET_DIR}/var/run/puppet.pid
name="puppet master"

status() {
    client_result ${pwd}
    if [ -f ${pid} ] && ( kill -0 $(< ${pid}) )
    then
        client_result "${name} is running"
    fi
}

start() {
    if [[ ! -f ${pid} ]]
    then
        echo "Starting puppet master"
	puppet master --config ${PUPPET_CFG_DIR}/puppet.conf &
        rc=${?}
        p=${!}
        if [[ ${rc} -ne 0 ]]
	then
            echo "${name} failed to start - ${rc}" 1>&2
            return ${rc}
        fi
        echo ${p} > ${pid}
    fi
}

stop() {
    if [[ -f ${pid} ]]
    then
    	kill $(<${pid})
    fi
    rm -f ${pid}
    return 0
}

restart() {
    stop
    start
}

build() {
    echo
}

post-deploy() {
    echo
}

pre-build() {
    echo
}

tidy() {
    echo
}

#
#  main():
#

# Ensure arguments.
if [[ $# -eq 0 ]]
then
    echo "Usage: ${0} [start|restart|stop|status]"
    exit 1
fi

# Handle commands.
case "${1}" in
    start)	start       ;;
    restart)	restart     ;;
    stop)	stop        ;;
    status)	status      ;;
    *)
	echo "Usage: ${0} [start|restart|stop|status]"
	exit 1
	;;
esac

exit 0
