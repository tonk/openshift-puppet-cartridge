#!/bin/bash
set -x
# XXX: Version is currently ignored
case "$1" in
  -v|--version)
    version="$2"
esac

source $OPENSHIFT_CARTRIDGE_SDK_BASH

FACTER_VERSION="2.2.0"
PUPPET_VERSION="3.6.2"
BASE="https://downloads.puppetlabs.com"

PUPPET_DIR=$OPENSHIFT_PUPPET_DIR

for x in bin lib man log etc var
do
  if [ ! -d $PUPPET_DIR/$x ]
  then
    mkdir -p $PUPPET_DIR/$x
  fi
done

if [ ! -d $OPENSHIFT_DATA_DIR/tmp ]
then
  mkdir $OPENSHIFT_DATA_DIR/tmp
fi
pushd $OPENSHIFT_DATA_DIR/tmp

pwd
curl -L -o ${FACTER_VERSION}.tar.gz ${BASE}/facter/facter-${FACTER_VERSION}.tar.gz
tar xvzf ${FACTER_VERSION}.tar.gz
mv facter-${FACTER_VERSION} facter
curl -L -o ${PUPPET_VERSION}.tar.gz ${BASE}/puppet/puppet-${PUPPET_VERSION}.tar.gz
tar xvzf ${PUPPET_VERSION}.tar.gz
mv puppet-${PUPPET_VERSION} puppet

popd

mkdir $OPENSHIFT_HOMEDIR/.puppet
export PATH=$PUPPET_DIR/bin:$PATH
export RUBYLIB=$PUPPET_DIR/lib
puppet --vardir=$OPENSHIFT_DATA_DIR/puppet				\
       --ssldir=$OPENSHIFT_DATA_DIR/puppet/ssl				\
       --templatedir=$OPENSHIFT_REPO_DIR/.openshift/puppet/templates	\
       --confdir=$OPENSHIFT_REPO_DIR/.openshift/puppet			\
       --genconfig > $OPENSHIFT_HOMEDIR/.puppet/puppet.conf

